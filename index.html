<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GIF Meme Generator</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="instagram-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/gif-frames@1.0.1/index.min.js"></script>
    <!-- Try CDNs for gifuct-js (frame decoder). If blocked, fall back to local vendor build (stub). -->
    <script src="https://cdn.jsdelivr.net/npm/gifuct-js@2.1.2/lib/index.js"></script>
    <script>window.gifuct = window.gifuct || (window.parseGIF && window.decompressFrames ? {parseGIF: window.parseGIF, decompressFrames: window.decompressFrames} : null);</script>
    <script src="https://unpkg.com/gifuct-js@2.1.2/lib/index.js"></script>
    <script>window.gifuct = window.gifuct || (window.parseGIF && window.decompressFrames ? {parseGIF: window.parseGIF, decompressFrames: window.decompressFrames} : null);</script>
    <script src="vendor/gifuct.min.js"></script>
    <!-- Fallback decoder: omggif (browser-ready) -->
    <script src="https://cdn.jsdelivr.net/npm/omggif@1.0.10/omggif.min.js"></script>
    <script type="module">
    // Try to load gifuct-js via ESM CDN and expose as window.gifuct
    (async () => {
        if (!window.gifuct || !window.gifuct.parseGIF) {
            try {
                const mod = await import('https://esm.sh/gifuct-js@2.1.2');
                if (mod && mod.parseGIF && mod.decompressFrames) {
                    window.gifuct = { parseGIF: mod.parseGIF, decompressFrames: mod.decompressFrames };
                    console.log('gifuct-js loaded via ESM CDN');
                }
            } catch (e) {
                console.warn('Failed to load gifuct-js via ESM CDN:', e);
            }
        }
    })();
    </script>
    <script type="module">
    // Preload gifenc (global-palette encoder) into window.__gifenc with robust fallbacks
    (async () => {
        if (!window.__gifenc) {
            // Try working CDN sources (removed broken local vendor path)
            const sources = [
                'https://cdn.jsdelivr.net/npm/gifenc@1.0.3/+esm',
                'https://unpkg.com/gifenc@1.0.3'
            ];
            for (const src of sources) {
                try {
                    const m = await import(src);
                    if (m && (m.GIFEncoder || m.quantize || m.applyPalette || m.default)) {
                        window.__gifenc = m;
                        console.log('gifenc loaded from', src);
                        break;
                    }
                } catch (e) {
                    console.warn('gifenc load failed from', src, e);
                }
            }
            if (!window.__gifenc) {
                console.warn('gifenc could not be preloaded; global-compat encoder will attempt runtime fallbacks.');
            }
        }
    })();
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé¨ GIF Meme Generator</h1>
            <p>Search for GIFs and add your custom text!</p>
        </header>

        <main>
            <!-- Search Section -->
            <section class="search-section">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search for GIFs..." />
                    <button id="searchBtn">Search</button>
                </div>
                <div id="giphyKey" class="api-key-section">
                    <input type="password" id="apiKeyInput" placeholder="Enter your Tenor API key" />
                    <button id="saveKeyBtn">Save Key</button>
                    <p class="info">Get your free API key from <a href="https://tenor.com/gifapi" target="_blank">Tenor GIF API</a></p>
                </div>
            </section>

            <!-- GIF Results -->
            <section class="results-section">
                <div id="gifResults" class="gif-grid"></div>
                <div id="pagination" class="pagination">
                    <button id="prevPageBtn" disabled>‚óÄ Prev</button>
                    <span id="pageInfo">Page 1</span>
                    <button id="nextPageBtn">Next ‚ñ∂</button>
                </div>
            </section>

            <!-- Editor Section -->
            <section class="editor-section" id="editorSection" style="display: none;">
                <div class="editor-container minimal">
                    <div class="canvas-container large">
                        <canvas id="gifCanvas"></canvas>
                        <div id="textOverlays"></div>
                        <button id="mobileAddTextBtn" class="add-text-button">Aa</button>
                        <div id="deleteZone" class="delete-zone">
                            <i class="fas fa-trash-alt"></i>
                        </div>
                    </div>
                    <div class="actions-bar">
                        <button id="addTextBtn" class="primary-action">Create Text</button>
                        <button id="clearTextBtn">Clear All Text</button>
                        <button id="quickGifBtn">Quick Static Image</button>
                        <button id="compatGifBtn" class="rainbow-glow-btn" title="Optimized for Facebook/Messenger">Create GIF for Messenger</button>
                        <button id="playPauseBtn">‚è∏Ô∏è Pause</button>
                        <button id="prevFrameBtn">‚èÆÔ∏è Prev</button>
                        <button id="nextFrameBtn">‚è≠Ô∏è Next</button>
                    </div>
                </div>
            </section>

            <!-- Progress and Download -->
            <section class="download-section" id="downloadSection" style="display: none;">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <p id="progressText">Generating GIF...</p>
                </div>
                <button id="downloadBtn" style="display: none;">Download GIF</button>
            </section>
        </main>
    </div>

    <script src="gif.min.js"></script>
    <!-- Optional: host a same-origin worker file for gif.js to avoid any CDN hiccups -->
    <!-- If you add gif.worker.js locally, script.js will prefer it automatically -->
    <script src="makeRotatable.js"></script>
    <script src="script.js"></script>
    
    <!-- Mobile context menu -->
    <div id="mobileContextMenu" class="mobile-context-menu">
        <div class="mobile-menu-item" data-action="edit">
            <i class="fas fa-pen"></i> Edit Text
        </div>
        <div class="mobile-menu-item" data-action="style">
            <i class="fas fa-paint-brush"></i> Change Style
        </div>
        <div class="mobile-menu-item" data-action="front">
            <i class="fas fa-layer-group"></i> Bring to Front
        </div>
        <div class="mobile-menu-item" data-action="back">
            <i class="fas fa-layer-group"></i> Send to Back
        </div>
        <div class="mobile-menu-item" data-action="duplicate">
            <i class="fas fa-copy"></i> Duplicate
        </div>
        <div class="mobile-menu-item delete" data-action="delete">
            <i class="fas fa-trash-alt"></i> Delete
        </div>
    </div>
    
    <!-- Touch indicator element -->
    <div id="touchIndicator" class="touch-indicator"></div>
</body>
</html>